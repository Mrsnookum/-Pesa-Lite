<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-Pesa Lite | Referral Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .bg-custom-purple { background-color: #4c1d95; }
        .text-custom-purple { color: #4c1d95; }
        
        .package-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            cursor: pointer;
        }
        .package-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #6d28d9;
        }
        
        .package-card.selected {
            border-color: #6d28d9;
            background-color: #f5f3ff;
        }

        .popular-badge {
            background: #6366f1;
            color: white;
            font-size: 10px;
            padding: 2px 10px;
            border-radius: 0 0 0 10px;
            font-weight: bold;
        }

        #loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            z-index: 100;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-10">

    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-900 mb-4"></div>
        <p class="text-xs font-bold text-purple-900">Processing with M-Pesa Lite...</p>
    </div>

    <nav class="bg-custom-purple p-4 text-white flex items-center shadow-lg">
        <button onclick="window.location.href='index.html'" class="mr-4 hover:opacity-80 transition">
            <i class="fa-solid fa-arrow-left text-lg"></i>
        </button>
        <h1 class="text-xl font-black italic tracking-tighter uppercase">M-PESA <span class="text-emerald-400">Lite</span></h1>
    </nav>

    <div class="max-w-md mx-auto p-6">
        
        <div class="text-center mb-10">
            <h2 id="page-title" class="text-2xl font-black text-slate-800 uppercase tracking-tight">Referral Hub</h2>
            <p id="page-subtitle" class="text-gray-500 text-[10px] font-bold mt-1">Activate a pack to start earning from 3 levels.</p>
        </div>

        <div id="link-section" class="mb-10 bg-white p-4 rounded-3xl border-2 border-dashed border-purple-200 hidden">
            <p class="text-[9px] font-black text-gray-400 uppercase mb-2">Your Unique Referral Link</p>
            <div class="flex gap-2">
                <input id="ref-url" type="text" readonly class="flex-1 bg-gray-50 border-none text-[10px] font-bold text-purple-800 p-2 rounded-xl focus:ring-0">
                <button onclick="copyRefLink()" class="bg-purple-900 text-white px-4 rounded-xl text-xs active:scale-90 transition">
                    <i class="fa-solid fa-copy"></i>
                </button>
            </div>
        </div>

        <div id="package-container" class="space-y-6 mb-10">
            <div onclick="initPaystack('Basic', 150, this)" class="package-card bg-white p-6 rounded-[2rem] shadow-sm relative overflow-hidden">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-black text-slate-800 uppercase text-lg">Basic Pack</h3>
                        <p class="text-custom-purple font-bold text-[10px] uppercase mt-1">60 Days Access • L1-L3 Earning</p>
                    </div>
                    <div class="text-right">
                        <span class="text-xl font-black text-slate-800 tracking-tight">Ksh 150</span>
                    </div>
                </div>
                <button class="w-full mt-6 bg-slate-900 text-white font-black py-3 rounded-2xl text-xs uppercase tracking-widest pointer-events-none">Activate Basic</button>
            </div>

            <div onclick="initPaystack('Pro', 500, this)" class="package-card bg-white p-6 rounded-[2rem] shadow-lg relative overflow-hidden border-2 border-indigo-200">
                <div class="absolute top-0 right-0 popular-badge uppercase">Popular</div>
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-black text-slate-800 uppercase text-lg text-indigo-900">Pro Pack</h3>
                        <p class="text-indigo-600 font-bold text-[10px] uppercase mt-1">90 Days Access • Higher Payouts</p>
                    </div>
                    <div class="text-right">
                        <span class="text-xl font-black text-slate-800 tracking-tight">Ksh 500</span>
                    </div>
                </div>
                <button class="w-full mt-6 bg-indigo-600 text-white font-black py-3 rounded-2xl text-xs uppercase tracking-widest pointer-events-none shadow-md">Activate Pro</button>
            </div>

            <div onclick="initPaystack('Premium', 1000, this)" class="package-card bg-white p-6 rounded-[2rem] shadow-sm relative overflow-hidden">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-black text-slate-800 uppercase text-lg">Premium Pack</h3>
                        <p class="text-purple-600 font-bold text-[10px] uppercase mt-1">90 Days Access • Max Commission</p>
                    </div>
                    <div class="text-right">
                        <span class="text-xl font-black text-slate-800 tracking-tight">Ksh 1,000</span>
                    </div>
                </div>
                <button class="w-full mt-6 bg-purple-700 text-white font-black py-3 rounded-2xl text-xs uppercase tracking-widest pointer-events-none">Activate Premium</button>
            </div>
        </div>

        <div class="bg-custom-purple rounded-[2.5rem] p-8 text-white shadow-2xl">
            <p class="text-[10px] opacity-70 uppercase font-black mb-1">Referral Wallet Balance</p>
            <div class="flex justify-between items-end mb-6">
                <h4 class="text-4xl font-black italic">Ksh <span id="ref-balance">0.00</span></h4>
                <div class="text-right">
                    <p class="text-[8px] opacity-60 uppercase font-bold">Payouts</p>
                    <p class="text-[10px] font-black text-emerald-400 uppercase tracking-tighter">Fri & Sat Only</p>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-2 mb-8 text-center">
                <div class="bg-white/10 p-3 rounded-2xl">
                    <p id="l1-count" class="text-lg font-black">0</p>
                    <p class="text-[7px] opacity-60 uppercase font-black">Direct</p>
                </div>
                <div class="bg-white/10 p-3 rounded-2xl">
                    <p id="l2-count" class="text-lg font-black">0</p>
                    <p class="text-[7px] opacity-60 uppercase font-black">Indirect</p>
                </div>
                <div class="bg-white/10 p-3 rounded-2xl">
                    <p id="l3-count" class="text-lg font-black">0</p>
                    <p class="text-[7px] opacity-60 uppercase font-black">Network</p>
                </div>
            </div>

            <button onclick="requestWithdrawal()" class="w-full bg-white text-custom-purple font-black py-4 rounded-2xl text-xs uppercase tracking-widest shadow-xl active:scale-95 transition hover:bg-gray-100">
                Withdraw Earnings
            </button>
            <p class="text-[8px] text-center mt-4 opacity-50 uppercase font-bold tracking-widest">Ksh 300 Minimum • Ksh 50 Fee Applies</p>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbx7aOqsSFHMrEdqeoKSJd18xSrvDN87HQPf4qZMiDkX0xJA6e5SPYIcXAe9aenOCnU/exec";
        const PAYSTACK_PK = "pk_live_ce8a56dfe0839cdc30d4cb6ed08f2635d89d7584";

        async function loadReferralData() {
            const uid = localStorage.getItem('activeUserId');
            if (!uid) return;

            document.getElementById('ref-url').value = `https://m-pesalite.top/?ref=${uid}`;

            try {
                const res = await fetch(`${API_URL}?action=getReferralData&userId=${uid}`);
                const data = await res.json();
                if (data.success) {
                    document.getElementById('ref-balance').innerText = data.balance.toFixed(2);
                    document.getElementById('l1-count').innerText = data.counts.l1;
                    document.getElementById('l2-count').innerText = data.counts.l2;
                    document.getElementById('l3-count').innerText = data.counts.l3;
                    
                    // Logic to handle active membership UI
                    if(data.tier !== "NONE") {
                        document.getElementById('link-section').classList.remove('hidden');
                        
                        // Hide packages and show status card
                        document.getElementById('package-container').style.display = 'none'; 
                        document.getElementById('page-title').innerText = "Membership Active";
                        document.getElementById('page-subtitle').style.display = 'none';

                        showStatusCard(data.tier, data.expiry);
                    }
                }
            } catch (e) { console.error("Referral Load Error"); }
        }

        // Status Card Injection
        function showStatusCard(tier, expiry) {
            const statusHtml = `
                <div class="bg-emerald-50 border-2 border-emerald-200 rounded-[2rem] p-6 mb-10 text-center">
                    <div class="inline-block bg-emerald-500 text-white text-[10px] font-black px-3 py-1 rounded-full uppercase mb-2">
                        Active License
                    </div>
                    <h3 class="text-xl font-black text-slate-800 uppercase">${tier} Plan</h3>
                    <p class="text-slate-500 text-[10px] font-bold mt-1">Valid until: ${expiry}</p>
                </div>
            `;
            const container = document.getElementById('package-container');
            container.insertAdjacentHTML('beforebegin', statusHtml);
        }

        function initPaystack(tier, price, element) {
            const uid = localStorage.getItem('activeUserId');
            if (!uid) return alert("Please log in to activate.");

            const formattedEmail = `${uid.toLowerCase()}@mgmail.com`;

            document.querySelectorAll('.package-card').forEach(c => c.classList.remove('selected'));
            element.classList.add('selected');

            const handler = PaystackPop.setup({
                key: PAYSTACK_PK,
                email: formattedEmail,
                amount: price * 100,
                currency: "KES",
                metadata: {
                    custom_fields: [
                        { display_name: "User ID", variable_name: "user_id", value: uid },
                        { display_name: "Tier", variable_name: "tier", value: tier }
                    ]
                },
                callback: function(response) {
                    activateTier(uid, tier, response.reference);
                }
            });
            handler.openIframe();
        }

        async function activateTier(uid, tier, ref) {
            document.getElementById('loading-overlay').style.display = 'flex';
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: "activateReferral",
                        userId: uid,
                        tier: tier,
                        reference: ref
                    })
                });
                const result = await res.json();
                alert(result.message);
                location.reload();
            } catch (e) { alert("Network Error: Activation Failed."); }
            document.getElementById('loading-overlay').style.display = 'none';
        }

        async function requestWithdrawal() {
            const userId = localStorage.getItem('activeUserId');
            if (!userId) return alert("Please log in first.");
            
            document.getElementById('loading-overlay').style.display = 'flex';
            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: "requestWithdrawal",
                        userId: userId,
                        amount: 300 
                    })
                });
                const result = await res.json();
                alert(result.message);
            } catch (e) { alert("Withdrawal Request Failed."); }
            document.getElementById('loading-overlay').style.display = 'none';
        }

        function copyRefLink() {
            const el = document.getElementById('ref-url');
            el.select();
            document.execCommand('copy');
            alert("Referral link copied!");
        }

        window.onload = loadReferralData;
    </script>
</body>
</html>
