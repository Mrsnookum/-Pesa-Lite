<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M-Pesa Lite | Secure Wallet</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="icon" type="image/png" href="logo.png">
    
    <style>
        .action-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); -webkit-tap-highlight-color: transparent; }
        .action-card:active { transform: scale(0.95); }
        .portfolio-footer { background: #0f172a; color: #94a3b8; }
        .social-link:hover { color: #22c55e; transition: color 0.3s ease; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-slate-100 flex justify-center min-h-screen font-sans select-none overflow-x-hidden">

    <div id="main-container" class="w-full max-w-md bg-white shadow-2xl relative overflow-hidden flex flex-col min-h-screen">
        
        <div class="bg-green-600 p-6 text-center text-white shrink-0 pt-10">
    <img src="logo.png" 
         alt="Logo" 
         onclick="window.location.href='admin.html'" 
         class="w-20 h-20 mx-auto rounded-full border-2 border-white mb-3 shadow-lg object-cover cursor-pointer active:scale-95 transition-transform">
    
    <div class="text-3xl font-black italic tracking-tighter uppercase">M-PESA <span class="font-light text-xl">Lite</span></div>
    <p class="text-green-100 text-[10px] uppercase tracking-widest mt-1 font-bold">Secure AI Gateway</p>
</div>

        <div id="auth-container" class="flex-grow overflow-y-auto">
            <div id="login-section" class="p-8 mt-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 uppercase tracking-tight">Access Wallet</h2>
                <div class="space-y-4">
                    <input type="tel" id="login-phone" placeholder="Phone Number" class="w-full p-4 border rounded-2xl outline-none focus:ring-2 focus:ring-green-500 bg-gray-50">
                    <input type="password" id="login-pin" maxlength="4" placeholder="4-Digit PIN" class="w-full p-4 border rounded-2xl outline-none focus:ring-2 focus:ring-green-500 bg-gray-50">
                    <button onclick="handleAuth('login')" id="login-btn" class="w-full bg-green-600 text-white font-black py-4 rounded-2xl hover:bg-green-700 transition uppercase text-sm shadow-lg">Sign In</button>
                    <p class="text-center text-xs text-gray-500 uppercase font-bold tracking-widest mt-6">New user? <a href="#" onclick="toggleAuth(true)" class="text-green-600">Create Account</a></p>
                </div>
            </div>

            <div id="register-section" class="hidden p-8 mt-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 uppercase tracking-tight">Create Identity</h2>
                <div class="space-y-4">
                    <input type="tel" id="reg-phone" placeholder="Phone Number" class="w-full p-4 border rounded-2xl outline-none bg-gray-50">
                    <input type="email" id="reg-email" placeholder="Recovery Email" class="w-full p-4 border rounded-2xl outline-none bg-gray-50">
                    <input type="password" id="reg-pin" maxlength="4" placeholder="Set 4-Digit PIN" class="w-full p-4 border rounded-2xl outline-none bg-gray-50">
                    <button onclick="handleAuth('register')" id="reg-btn" class="w-full bg-green-600 text-white font-black py-4 rounded-2xl hover:bg-green-700 transition uppercase text-sm shadow-lg">Register Account</button>
                    <p class="text-center text-xs text-gray-500 uppercase font-bold tracking-widest mt-6">Joined before? <a href="#" onclick="toggleAuth(false)" class="text-green-600">Login</a></p>
                </div>
            </div>

            <div id="appeal-section" class="hidden p-8 bg-red-50 border-t-4 border-red-500 text-center">
                <i class="fa-solid fa-user-lock text-5xl text-red-500 mb-3"></i>
                <h2 class="text-xl font-bold text-red-800 uppercase mb-4">Account Frozen</h2>
                <textarea id="appeal-msg" rows="4" placeholder="Explain why your account should be reactivated..." class="w-full p-3 text-sm border border-red-200 rounded-2xl outline-none mb-4 focus:ring-2 focus:ring-red-500"></textarea>
                <button onclick="submitAppeal()" id="appeal-btn" class="w-full bg-red-600 text-white font-bold py-4 rounded-xl uppercase text-sm mb-4">Send Appeal</button>
                <button onclick="location.reload()" class="text-gray-400 text-xs font-bold uppercase hover:underline">Return to Login</button>
            </div>
        </div>

        <div id="dashboard-section" class="hidden flex-grow flex flex-col overflow-hidden">
            <div class="p-6 overflow-y-auto space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">System Status</p>
                        <span id="status-badge" class="bg-green-100 text-green-700 text-[10px] font-black px-4 py-1 rounded-full uppercase tracking-tighter">Active</span>
                    </div>
                    <button onclick="logout()" class="text-red-500 font-bold text-xs uppercase tracking-tighter hover:underline">Exit</button>
                </div>

                <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden">
                    <p class="text-[10px] uppercase tracking-[0.2em] opacity-60">Account Balance</p>
                    <h3 class="text-4xl font-bold mt-1 tracking-tight">Ksh <span id="balance-display">0.00</span></h3>
                    <p class="text-[8px] opacity-40 mt-4 tracking-widest uppercase italic">Ceiling: Ksh 100,000</p>
                </div>

                <div class="grid grid-cols-4 gap-2">
                    <button onclick="showDepositNotice()" class="action-card flex flex-col items-center justify-center p-3 bg-orange-50 rounded-xl border border-orange-100 shadow-sm">
                        <i class="fa-solid fa-plus text-orange-600 text-lg mb-1"></i>
                        <span class="text-[9px] font-black uppercase text-orange-800">Deposit</span>
                    </button>
                    <button onclick="openSendModal()" class="action-card flex flex-col items-center justify-center p-3 bg-green-50 rounded-xl border border-green-100 shadow-sm">
                        <i class="fa-solid fa-paper-plane text-green-600 text-lg mb-1"></i>
                        <span class="text-[9px] font-black uppercase text-green-800">Send</span>
                    </button>
                    <button onclick="openRequestModal()" class="action-card flex flex-col items-center justify-center p-3 bg-purple-50 rounded-xl border border-purple-100 shadow-sm">
                        <i class="fa-solid fa-hand-holding-dollar text-purple-600 text-lg mb-1"></i>
                        <span class="text-[9px] font-black uppercase text-purple-800">Request</span>
                    </button>
                    <button onclick="alert('ðŸš€ Coming soon!')" class="action-card flex flex-col items-center justify-center p-3 bg-blue-50 rounded-xl border border-blue-100 shadow-sm">
                        <i class="fa-solid fa-wallet text-blue-600 text-lg mb-1"></i>
                        <span class="text-[9px] font-black uppercase text-blue-800">Bank</span>
                    </button>
                
                    <button onclick="window.location.href='jobs.html'" class="action-card flex flex-col items-center justify-center p-3 bg-indigo-50 rounded-xl border border-indigo-100 shadow-sm">
                       <i class="fa-solid fa-briefcase text-indigo-600 text-lg mb-1"></i>
                       <span class="text-[9px] font-black uppercase text-indigo-800">Jobs Portal</span>
                    </button>

                    <button onclick="window.location.href='tasks.html'" class="action-card flex flex-col items-center justify-center p-3 bg-purple-100 rounded-xl border border-purple-200 shadow-sm">
                        <i class="fa-solid fa-list-check text-purple-600 text-lg mb-1"></i>
                        <span class="text-[9px] font-black uppercase text-purple-800">My Tasks</span>
                    </button>


                </div>
                <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100">
                    <h4 class="text-xs font-black text-blue-700 uppercase mb-3 flex items-center"><i class="fa-solid fa-key mr-2"></i> Security PIN</h4>
                    <div class="space-y-2">
                        <input type="password" id="old-pin" maxlength="4" placeholder="Current PIN" class="w-full p-2 text-sm border rounded-xl outline-none bg-white">
                        <input type="password" id="new-pin" maxlength="4" placeholder="New PIN" class="w-full p-2 text-sm border rounded-xl outline-none bg-white">
                        <button onclick="updatePin()" id="pin-btn" class="w-full bg-blue-600 text-white text-[10px] font-bold py-3 rounded-xl uppercase shadow-md transition-all active:bg-blue-800">Update PIN</button>
                    </div>
                </div>

                <h4 class="text-xs font-black text-gray-400 uppercase tracking-[0.2em] mb-2">Transactions</h4>
                <div id="history-list" class="space-y-3"></div>

                <div class="bg-white rounded-3xl p-4 shadow-sm border border-gray-100 mb-4">
                    <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3 text-center">Cash Flow Analytics</h4>
                    <canvas id="spendingChart" height="200"></canvas>
                </div>
            </div>
        </div>

        <footer class="bg-slate-900 py-8 px-6 text-center shrink-0 border-t border-slate-800 mt-auto">
    <div class="flex flex-col items-center gap-2">
        <div class="w-8 h-1 bg-green-500 rounded-full mb-2 opacity-50"></div>
        <p class="text-[9px] font-black text-white uppercase tracking-[0.3em]">
            M-PESA <span class="font-light opacity-60">Lite</span>
        </p>
        <p class="text-[8px] text-slate-500 uppercase tracking-widest font-bold mt-1">
            &copy; 2025 M-Pesa Lite. All Rights Reserved.
        </p>
        <p class="text-[7px] text-slate-600 uppercase tracking-tighter italic">
            Secure AI Gateway Terminal
        </p>
    </div>
</footer>

        <div id="request-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
                <h2 class="text-xl font-black mb-1 uppercase tracking-tighter text-gray-800">Request Funds</h2>
                <p class="text-[9px] text-purple-600 font-bold mb-4 uppercase tracking-widest">Manual Admin Approval</p>
                <div class="space-y-4">
                    <input type="number" id="req-amount" placeholder="Amount (Ksh)" class="w-full border p-4 rounded-2xl outline-none bg-gray-50 focus:ring-2 focus:ring-purple-500">
                    <textarea id="req-note" rows="2" placeholder="Reason for request..." class="w-full border p-4 rounded-2xl outline-none bg-gray-50 focus:ring-2 focus:ring-purple-500 text-sm"></textarea>
                    <div class="flex gap-3 pt-2">
                        <button onclick="closeRequestModal()" class="flex-1 bg-gray-100 p-4 rounded-2xl font-bold text-xs uppercase tracking-widest text-gray-400">Cancel</button>
                        <button onclick="submitCreditRequest()" id="confirm-req-btn" class="flex-1 bg-purple-600 text-white p-4 rounded-2xl font-bold text-xs uppercase tracking-widest shadow-lg">Send Request</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="send-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl text-center">
                <h2 class="text-xl font-black mb-2 uppercase tracking-tighter text-gray-800">Send Money</h2>
                <p class="text-[10px] text-gray-400 mb-4 tracking-widest uppercase">Limit: Ksh 50,000 / Day</p>
                <div class="space-y-4">
                    <input type="tel" id="send-phone" placeholder="Recipient Phone" class="w-full border p-4 rounded-2xl outline-none bg-gray-50 focus:ring-2 focus:ring-green-500">
                    <input type="number" id="send-amount" placeholder="Amount (Ksh)" class="w-full border p-4 rounded-2xl outline-none bg-gray-50 focus:ring-2 focus:ring-green-500">
                    <div class="flex gap-3 pt-2">
                        <button onclick="closeSendModal()" class="flex-1 bg-gray-100 p-4 rounded-2xl font-bold text-xs uppercase tracking-widest text-gray-400">Cancel</button>
                        <button onclick="executeTransfer()" id="confirm-send-btn" class="flex-1 bg-green-600 text-white p-4 rounded-2xl font-bold text-xs uppercase tracking-widest shadow-lg">Confirm</button>
                    </div>
                </div>
            </div>
        </div>
    </div>


<div id="deposit-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50 backdrop-blur-sm">
            <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
                <h2 class="text-xl font-black mb-1 uppercase tracking-tighter text-gray-800">Verify Deposit</h2>
                <p class="text-[9px] text-orange-600 font-bold mb-4 uppercase">Submit Paystack Reference</p>
                <div class="space-y-4">
                    <input type="text" id="dep-ref" placeholder="Transaction Reference ID" class="w-full border p-4 rounded-2xl outline-none bg-gray-50 focus:ring-2 focus:ring-orange-500 font-mono text-sm uppercase">
                    <input type="number" id="dep-amount" placeholder="Exact Amount Paid (Ksh)" class="w-full border p-4 rounded-2xl outline-none bg-gray-50 focus:ring-2 focus:ring-orange-500">
                    <div class="flex gap-3 pt-2">
                        <button onclick="closeDepositModal()" class="flex-1 bg-gray-100 p-4 rounded-2xl font-bold text-[10px] uppercase text-gray-400">Cancel</button>
                        <button onclick="claimDeposit()" id="confirm-dep-btn" class="flex-1 bg-orange-600 text-white p-4 rounded-2xl font-bold text-[10px] uppercase shadow-lg">Verify Payment</button>
                    </div>
                </div>
            </div>
        </div>
        </div>


    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwJr-E6liEPTtNaS6rTIERpXy0x8R0VhK7G_jpO40fvkk7RtZIh-ZY1t2RjL8D1dXs/exec";
        let spendingChart;

        // FIXED: Re-enabled persistence
        window.onload = () => {
            const savedUser = localStorage.getItem('activeUserId');
            if (savedUser) {
                fetch(`${WEB_APP_URL}?action=getBalance&userId=${savedUser}`)
                    .then(res => res.json())
                    .then(result => { if (result.success) loadDashboard(result); else logout(); })
                    .catch(() => logout());
            }
        };


        // DEPOSIT REDIRECT LOGIC
        function showDepositNotice() {
            const userId = localStorage.getItem('activeUserId');
            if(!userId) return alert("Security Error: Please Login");
            alert("Redirecting to Paystack Shop. IMPORTANT: Copy your Order/Reference ID after payment to claim your credit.");
            window.location.href = "https://paystack.shop/pay/-nespso12-";
        }

        function openDepositModal() { document.getElementById('deposit-modal').classList.remove('hidden'); }
        function closeDepositModal() { document.getElementById('deposit-modal').classList.add('hidden'); }

        // --- AUTHENTICATION ---
        async function handleAuth(action) {
            const isLogin = action === 'login';
            const phone = document.getElementById(isLogin ? 'login-phone' : 'reg-phone').value;
            const pin = document.getElementById(isLogin ? 'login-pin' : 'reg-pin').value;
            const email = isLogin ? "" : document.getElementById('reg-email').value;

            if (!phone || !pin) return alert("Phone and PIN required.");
            const btn = document.getElementById(isLogin ? 'login-btn' : 'reg-btn');
            btn.disabled = true; btn.innerText = "AUTHENTICATING...";

            try {
                const response = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action, phone, pin, email }) });
                const result = await response.json();
                if (result.success) {
                    localStorage.setItem('activeUserId', result.userId);
                    localStorage.setItem('userPhone', phone);
                    loadDashboard(result);
                } else { 
                    if (result.message.includes("ACCOUNT_FROZEN")) {
                        document.getElementById('login-section').classList.add('hidden');
                        document.getElementById('appeal-section').classList.remove('hidden');
                        localStorage.setItem('tempFrozenPhone', phone);
                    } else { alert(result.message); }
                }
            } catch (err) { alert("System offline."); }
            finally { btn.disabled = false; btn.innerText = isLogin ? "Sign In" : "Register Account"; }
        }

        // --- UPDATED: REQUEST FUNDS LOGIC ---
async function submitCreditRequest() {
    const amount = document.getElementById('req-amount').value;
    const note = document.getElementById('req-note').value;
    const btn = document.getElementById('confirm-req-btn');

    if (!amount || amount <= 0) return alert("Please enter a valid amount.");
    
    btn.disabled = true;
    btn.innerText = "SENDING...";

    try {
        const response = await fetch(WEB_APP_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'requestCredit',
                userId: localStorage.getItem('activeUserId'),
                phone: localStorage.getItem('userPhone'),
                amount,
                note
            })
        });
        const result = await response.json();
        
        // Custom Feature Notice
        alert("Success: " + result.message + "\n\nðŸš€ Brighton will work on this feature soon to make it available stay tuned!");
        
        closeRequestModal();
    } catch (e) {
        alert("Failed to reach server. Please try again.");
    } finally {
        btn.disabled = false;
        btn.innerText = "Send Request";
    }
}
        // --- CORE UI FUNCTIONS ---
        //function showDepositNotice() { alert("ðŸš€ Brighton will work on this feature soon to make it available stay tuned!"); }
        function openRequestModal() { document.getElementById('request-modal').classList.remove('hidden'); }
        function closeRequestModal() { document.getElementById('request-modal').classList.add('hidden'); }
        function openSendModal() { document.getElementById('send-modal').classList.remove('hidden'); }
        function closeSendModal() { document.getElementById('send-modal').classList.add('hidden'); }
        function logout() { localStorage.clear(); location.reload(); }
        function toggleAuth(showReg) { document.getElementById('login-section').classList.toggle('hidden', showReg); document.getElementById('register-section').classList.toggle('hidden', !showReg); }

        async function executeTransfer() {
            const phone = document.getElementById('send-phone').value;
            const amount = document.getElementById('send-amount').value;
            const btn = document.getElementById('confirm-send-btn');
            if (!phone || !amount) return alert("Details missing");
            btn.disabled = true; btn.innerText = "SENDING...";
            try {
                const response = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'transfer', senderId: localStorage.getItem('activeUserId'), phone, amount }) });
                const result = await response.json();
                if (result.success) { alert(result.message); location.reload(); }
                else { alert(result.message); }
            } catch (e) { alert("Connection Error."); }
            finally { btn.disabled = false; btn.innerText = "Confirm"; }
        }

        function loadDashboard(data) {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            const badge = document.getElementById('status-badge');
            badge.innerText = data.status || "ACTIVE";
            badge.className = (data.status === 'ACTIVE') ? 'bg-green-100 text-green-700 text-[10px] font-black px-4 py-1 rounded-full uppercase tracking-tighter' : 'bg-red-100 text-red-700 text-[10px] font-black px-4 py-1 rounded-full uppercase tracking-tighter';
            document.getElementById('balance-display').innerText = parseFloat(data.balance || 0).toFixed(2);
            fetchHistory();
        }

        async function fetchHistory() {
            const res = await fetch(`${WEB_APP_URL}?action=getHistory&userId=${localStorage.getItem('activeUserId')}`);
            const result = await res.json();
            if (result.success) { renderHistory(result.transactions); updateChart(result.transactions); }
        }

        function updateChart(txns) {
            const ctx = document.getElementById('spendingChart').getContext('2d');
            const sent = txns.filter(t => t.type === 'SENT').reduce((s, t) => s + Number(t.amount), 0);
            const rcv = txns.filter(t => t.type === 'RECEIVED').reduce((s, t) => s + Number(t.amount), 0);
            if (spendingChart) spendingChart.destroy();
            spendingChart = new Chart(ctx, {
                type: 'bar', data: { labels: ['Sent', 'Received'], datasets: [{ data: [sent, rcv], backgroundColor: ['#ef4444', '#16a34a'], borderRadius: 10 }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } }
            });
        }

        function renderHistory(txns) {
            const container = document.getElementById('history-list');
            if (!txns || txns.length === 0) return container.innerHTML = '<p class="text-center text-gray-400 text-xs py-4 italic uppercase opacity-40">No History Found</p>';
            container.innerHTML = txns.map(tx => `
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-2xl mb-2 border border-gray-100">
                    <div>
                        <p class="text-[10px] font-black ${tx.type === 'SENT' ? 'text-red-500' : 'text-green-600'} uppercase tracking-tighter">${tx.type}</p>
                        <p class="text-[8px] text-gray-400 font-bold uppercase">${new Date(tx.timestamp).toLocaleDateString()}</p>
                    </div>
                    <p class="font-black text-sm ${tx.type === 'SENT' ? 'text-red-600' : 'text-green-600'}">Ksh ${parseFloat(tx.amount).toFixed(2)}</p>
                </div>
            `).join('');
        }

        async function updatePin() {
            const oldPin = document.getElementById('old-pin').value;
            const newPin = document.getElementById('new-pin').value;
            const btn = document.getElementById('pin-btn');
            if (oldPin.length !== 4 || newPin.length !== 4) return alert("PIN must be 4 digits");
            btn.innerText = "UPDATING..."; btn.disabled = true;
            try {
                const response = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'changePin', userId: localStorage.getItem('activeUserId'), oldPin, newPin }) });
                const result = await response.json();
                alert(result.message);
                if(result.success) location.reload();
            } catch (e) { alert("PIN update failed."); }
            finally { btn.innerText = "Update PIN"; btn.disabled = false; }
        }
    </script>
</body>
</html>