<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M-Pesa Lite | Secure Wallet</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <link rel="icon" type="image/png" href="logo.png">
    
    <style>
        .action-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); -webkit-tap-highlight-color: transparent; }
        .action-card:active { transform: scale(0.95); }
        ::-webkit-scrollbar { display: none; }
        .chart-container { position: relative; height: 180px; width: 100%; }
    </style>
</head>
<body class="bg-slate-100 flex justify-center min-h-screen font-sans select-none overflow-x-hidden">

    <div id="main-container" class="w-full max-w-md bg-white shadow-2xl relative overflow-hidden flex flex-col min-h-screen">
        
        <div class="bg-green-600 p-6 text-center text-white shrink-0 pt-10">
            <img src="logo.png" alt="Logo" onclick="window.location.href='admin.html'" 
                 class="w-20 h-20 mx-auto rounded-full border-2 border-white mb-3 shadow-lg object-cover cursor-pointer active:scale-95 transition-transform">
            <div class="text-3xl font-black italic tracking-tighter uppercase">M-PESA <span class="font-light text-xl">Lite</span></div>
            <p class="text-green-100 text-[10px] uppercase tracking-widest mt-1 font-bold">Secure AI Gateway</p>
        </div>

        <div id="auth-container" class="flex-grow overflow-y-auto">
            <div id="login-section" class="p-8 mt-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 uppercase tracking-tight">Access Wallet</h2>
                <div class="space-y-4">
                    <input type="tel" id="login-phone" placeholder="Phone Number" class="w-full p-4 border rounded-2xl outline-none focus:ring-2 focus:ring-green-500 bg-gray-50 font-bold">
                    <input type="password" id="login-pin" maxlength="4" placeholder="4-Digit PIN" class="w-full p-4 border rounded-2xl outline-none focus:ring-2 focus:ring-green-500 bg-gray-50 font-bold">
                    <button onclick="handleAuth('login')" id="login-btn" class="w-full bg-green-600 text-white font-black py-4 rounded-2xl hover:bg-green-700 transition uppercase text-sm shadow-lg">Sign In</button>
                    <p class="text-center text-xs text-gray-500 uppercase font-bold tracking-widest mt-6">New user? <a href="#" onclick="toggleAuth(true)" class="text-green-600">Create Account</a></p>
                </div>
            </div>

            <div id="register-section" class="hidden p-8 mt-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 uppercase tracking-tight">Create Identity</h2>
                <div class="space-y-4">
                    <input type="tel" id="reg-phone" placeholder="Phone Number" class="w-full p-4 border rounded-2xl outline-none bg-gray-50 font-bold">
                    <input type="email" id="reg-email" placeholder="Recovery Email" class="w-full p-4 border rounded-2xl outline-none bg-gray-50 font-bold">
                    <input type="password" id="reg-pin" maxlength="4" placeholder="Set 4-Digit PIN" class="w-full p-4 border rounded-2xl outline-none bg-gray-50 font-bold">
                    
                    <div class="pt-2 border-t border-dashed border-gray-200">
                        <label class="text-[9px] font-black text-slate-400 uppercase ml-1">Referrer ID (Optional)</label>
                        <input type="text" id="reg-referrer" placeholder="e.g. U-123456" class="w-full p-4 border rounded-2xl outline-none bg-emerald-50 text-emerald-800 font-bold border-emerald-100 mt-1 italic">
                    </div>

                    <button onclick="handleAuth('register')" id="reg-btn" class="w-full bg-green-600 text-white font-black py-4 rounded-2xl hover:bg-green-700 transition uppercase text-sm shadow-lg">Register Account</button>
                    <p class="text-center text-xs text-gray-500 uppercase font-bold tracking-widest mt-6">Joined before? <a href="#" onclick="toggleAuth(false)" class="text-green-600">Login</a></p>
                </div>
            </div>
        </div>

        <div id="dashboard-section" class="hidden flex-grow flex flex-col overflow-hidden">
            <div class="p-6 overflow-y-auto space-y-6">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">System Status</p>
                        <span id="status-badge" class="bg-green-100 text-green-700 text-[10px] font-black px-4 py-1 rounded-full uppercase tracking-tighter">Active</span>
                    </div>
                    <button onclick="logout()" class="text-red-500 font-bold text-xs uppercase tracking-tighter">Exit</button>
                </div>

                <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-3xl p-6 text-white shadow-2xl relative overflow-hidden">
                    <p class="text-[10px] uppercase tracking-[0.2em] opacity-60">Account Balance</p>
                    <h3 class="text-4xl font-bold mt-1 tracking-tight">Ksh <span id="balance-display">0.00</span></h3>
                    <div class="flex justify-between mt-4">
                        <p class="text-[8px] opacity-40 tracking-widest uppercase italic">Limit: Ksh 100k</p>
                        <p id="user-id-display" class="text-[8px] opacity-60 font-bold uppercase"></p>
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-3">
                    <button onclick="openDepositModal()" class="action-card flex flex-col items-center justify-center p-3 bg-orange-50 rounded-2xl border border-orange-100">
                        <i class="fa-solid fa-plus text-orange-600 text-lg mb-1"></i>
                        <span class="text-[9px] font-black uppercase text-orange-800">Deposit</span>
                    </button>
                    <button onclick="openSendModal()" class="action-card flex flex-col items-center justify-center p-3 bg-green-50 rounded-2xl border border-green-100">
                        <i class="fa-solid fa-paper-plane text-green-600 text-lg mb-1"></i>
                        <span class="text-[9px] font-black uppercase text-green-800">Send</span>
                    </button>
                    <button onclick="openRequestModal()" class="action-card flex flex-col items-center justify-center p-3 bg-purple-50 rounded-2xl border border-purple-100">
                        <i class="fa-solid fa-hand-holding-dollar text-purple-600 text-lg mb-1"></i>
                        <span class="text-[9px] font-black uppercase text-purple-800">Request</span>
                    </button>
                    <button onclick="alert('Bank withdrawals coming soon!')" class="action-card flex flex-col items-center justify-center p-3 bg-blue-50 rounded-2xl border border-blue-100">
                        <i class="fa-solid fa-building-columns text-blue-600 text-lg mb-1"></i>
                        <span class="text-[9px] font-black uppercase text-blue-800">Bank</span>
                    </button>
                    <button onclick="window.location.href='jobs.html'" class="action-card flex flex-col items-center justify-center p-3 bg-indigo-50 rounded-2xl border border-indigo-100">
                       <i class="fa-solid fa-briefcase text-indigo-600 text-lg mb-1"></i>
                       <span class="text-[9px] font-black uppercase text-indigo-800">Jobs</span>
                    </button>
                    <button onclick="window.location.href='tasks.html'" class="action-card flex flex-col items-center justify-center p-3 bg-rose-50 rounded-2xl border border-rose-100">
                        <i class="fa-solid fa-list-check text-rose-600 text-lg mb-1"></i>
                        <span class="text-[9px] font-black uppercase text-rose-800">Tasks</span>
                    </button>
                    <button onclick="window.location.href='referral.html'" class="action-card flex flex-col items-center justify-center p-3 bg-emerald-50 rounded-2xl border border-emerald-100">
                        <i class="fa-solid fa-users text-emerald-600 text-lg mb-1"></i>
                        <span class="text-[9px] font-black uppercase text-emerald-800">Referrals</span>
                    </button>
                    <button onclick="document.getElementById('history-list').scrollIntoView({behavior: 'smooth'})" class="action-card flex flex-col items-center justify-center p-3 bg-slate-50 rounded-2xl border border-slate-100">
                        <i class="fa-solid fa-clock-rotate-left text-slate-600 text-lg mb-1"></i>
                        <span class="text-[9px] font-black uppercase text-slate-800">History</span>
                    </button>
                </div>

                <div class="bg-white rounded-3xl p-5 shadow-sm border border-gray-100">
                    <h4 class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-4 text-center">Cash Flow Analytics</h4>
                    <div class="chart-container">
                        <canvas id="spendingChart"></canvas>
                    </div>
                </div>

                <div class="space-y-2">
                    <h4 class="text-xs font-black text-gray-400 uppercase tracking-[0.2em] mb-2 px-2">Transactions</h4>
                    <div id="history-list" class="space-y-3 pb-10"></div>
                </div>
            </div>
        </div>

        <footer class="bg-slate-900 py-6 px-6 text-center shrink-0 border-t border-slate-800 mt-auto">
            <p class="text-[9px] font-black text-white uppercase tracking-[0.3em]">M-PESA <span class="font-light opacity-60">Lite</span></p>
            <p class="text-[8px] text-slate-500 uppercase tracking-widest font-bold mt-1">&copy; 2026 M-Pesa Lite. All Rights Reserved.</p>
        </footer>
    </div>

    <div id="send-modal" class="hidden fixed inset-0 bg-black/60 z-50 backdrop-blur-sm flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl">
            <h2 class="font-black uppercase mb-1 text-gray-800">Send Money</h2>
            <p class="text-[10px] text-gray-400 mb-4 uppercase">Direct P2P Transfer</p>
            <input type="tel" id="send-phone" placeholder="Recipient Phone" class="w-full p-4 bg-gray-50 rounded-2xl mb-3 outline-none border text-sm font-bold">
            <input type="number" id="send-amount" placeholder="Amount Ksh" class="w-full p-4 bg-gray-50 rounded-2xl mb-4 outline-none border text-sm font-bold">
            <div class="flex gap-2">
                <button onclick="closeModal('send-modal')" class="flex-1 py-4 font-bold text-[10px] uppercase bg-gray-100 text-gray-400 rounded-2xl">Cancel</button>
                <button onclick="executeTransfer()" id="confirm-send-btn" class="flex-1 py-4 font-bold text-[10px] uppercase bg-green-600 text-white rounded-2xl shadow-lg">Confirm</button>
            </div>
        </div>
    </div>

    <div id="new-year-modal" class="hidden fixed inset-0 bg-black/80 z-[100] backdrop-blur-md flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-xs rounded-3xl p-8 text-center shadow-2xl border-4 border-yellow-400 relative">
            <div class="text-5xl mb-2 animate-bounce">üéÅ</div>
            <h2 class="text-2xl font-black text-gray-800 uppercase leading-tight">New Year Giveaway!</h2>
            <p class="text-sm text-gray-600 mt-2 font-medium">Activate your first pack <span class="text-green-600 font-bold">TODAY</span> and receive an instant <span class="font-bold text-red-600">Cashback Reward</span> up to Ksh 550!</p>
            <div class="mt-4 space-y-1 text-[10px] font-bold uppercase text-gray-500 bg-slate-50 p-3 rounded-2xl">
                <p class="text-emerald-600">Premium: +550 Cashback</p>
                <p class="text-blue-600">Pro: +250 Cashback</p>
                <p class="text-orange-600">Basic: +100 Cashback</p>
            </div>
            <button onclick="claimAndCelebrate()" class="mt-6 w-full py-4 bg-green-600 text-white font-black rounded-2xl shadow-lg uppercase text-xs tracking-widest active:scale-95 transition-all">Claim Now</button>
        </div>
    </div>

    <script>
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzwpjXXNtBG7ygZdkE4JKP2c5rbuYn2ux-EHhR0B5LHn5jy7neyJ0tfFI8vSCoyh3A/exec";
        let spendingChart;

        function claimAndCelebrate() {
            // Trigger Confetti
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 }
            });

            // Redirect to referral.html after celebration
            setTimeout(() => {
                window.location.href = 'referral.html';
            }, 1200);
        }

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const ref = urlParams.get('ref');
            if (ref) {
                document.getElementById('reg-referrer').value = ref;
                document.getElementById('reg-referrer').readOnly = true;
            }

            const savedUser = localStorage.getItem('activeUserId');
            if (savedUser) {
                document.getElementById('user-id-display').innerText = "ID: " + savedUser;
                fetchDashboard(savedUser);
            }
        };

        async function fetchDashboard(uid) {
            try {
                const res = await fetch(`${WEB_APP_URL}?action=getBalance&userId=${uid}`);
                const data = await res.json();
                if (data.success) {
                    loadDashboard(data);
                    
                    // NEW YEAR GIVEAWAY TRIGGER
                    const today = new Date();
                    const month = today.getMonth() + 1;
                    const date = today.getDate();

                    // Logic: Show if it's December 31st OR January 1st to 5th
                    if (data.isNewUser && ((month === 12 && date === 31) || (month === 1 && date <= 5))) {
                        document.getElementById('new-year-modal').classList.remove('hidden');
                    }

                } else {
                    logout();
                }
            } catch (e) { console.error("Sync error"); }
        }

        async function handleAuth(action) {
            const isLogin = action === 'login';
            const phone = document.getElementById(isLogin ? 'login-phone' : 'reg-phone').value;
            const pin = document.getElementById(isLogin ? 'login-pin' : 'reg-pin').value;
            const email = isLogin ? "" : document.getElementById('reg-email').value;
            const referrerId = isLogin ? "" : (document.getElementById('reg-referrer').value || "SYSTEM");

            if (!phone || !pin) return alert("Details required");
            const btn = document.getElementById(isLogin ? 'login-btn' : 'reg-btn');
            btn.disabled = true; btn.innerText = "WAIT...";

            try {
                const response = await fetch(WEB_APP_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action, phone, pin, email, referrerId }) 
                });
                const result = await response.json();
                if (result.success) {
                    if(isLogin) {
                        localStorage.setItem('activeUserId', result.userId);
                        location.reload();
                    } else {
                        alert("Account Created! You can now Sign In.");
                        toggleAuth(false);
                    }
                } else { alert(result.message); }
            } catch (err) { alert("System offline."); }
            finally { btn.disabled = false; btn.innerText = isLogin ? "Sign In" : "Register Account"; }
        }

        async function executeTransfer() {
            const phone = document.getElementById('send-phone').value;
            const amount = document.getElementById('send-amount').value;
            const btn = document.getElementById('confirm-send-btn');
            const senderId = localStorage.getItem('activeUserId');

            if (!phone || !amount || amount <= 0) return alert("Enter valid details");
            btn.disabled = true; btn.innerText = "SENDING...";

            try {
                const res = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'transfer', senderId, phone, amount })
                });
                const result = await res.json();
                if (result.success) {
                    alert(result.message);
                    location.reload();
                } else {
                    alert("Error: " + result.message);
                }
            } catch (e) { alert("Failed to connect."); }
            finally { btn.disabled = false; btn.innerText = "Confirm"; }
        }

        function loadDashboard(data) {
            document.getElementById('auth-container').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            document.getElementById('balance-display').innerText = parseFloat(data.balance || 0).toFixed(2);
            fetchHistory();
        }

        async function fetchHistory() {
            const uid = localStorage.getItem('activeUserId');
            const res = await fetch(`${WEB_APP_URL}?action=getHistory&userId=${uid}`);
            const result = await res.json();
            if (result.success) {
                renderHistory(result.transactions);
                initChart(result.transactions);
            }
        }

        function renderHistory(txns) {
            const container = document.getElementById('history-list');
            if (!txns || txns.length === 0) return container.innerHTML = '<p class="text-center text-gray-400 text-[10px] py-4">NO TRANSACTIONS</p>';
            container.innerHTML = txns.map(tx => `
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-2xl mb-2 border border-gray-100">
                    <div>
                        <p class="text-[10px] font-black uppercase ${tx.type === 'SENT' ? 'text-red-500' : 'text-green-600'}">${tx.type}</p>
                        <p class="text-[8px] text-gray-400 font-bold uppercase">${new Date(tx.timestamp).toLocaleDateString()}</p>
                    </div>
                    <p class="font-black text-sm text-slate-800">Ksh ${parseFloat(tx.amount).toFixed(2)}</p>
                </div>
            `).join('');
        }

        function initChart(txns) {
            const ctx = document.getElementById('spendingChart').getContext('2d');
            const sent = txns.filter(t => t.type === 'SENT').reduce((s, t) => s + Number(t.amount), 0);
            const received = txns.filter(t => t.type === 'RECEIVED' || t.type === 'DEPOSIT').reduce((s, t) => s + Number(t.amount), 0);

            if (spendingChart) spendingChart.destroy();
            spendingChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Sent', 'Received'],
                    datasets: [{
                        data: [sent, received],
                        backgroundColor: ['#f43f5e', '#10b981'],
                        borderRadius: 12,
                        barThickness: 45
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { display: false }, x: { grid: { display: false } } }
                }
            });
        }

        function openDepositModal() { window.location.href = "https://paystack.shop/pay/m-pesalite"; }
        function openSendModal() { document.getElementById('send-modal').classList.remove('hidden'); }
        function openRequestModal() { alert("Manual credit requests must be approved by admin."); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function logout() { localStorage.clear(); location.reload(); }
        function toggleAuth(showReg) { 
            document.getElementById('login-section').classList.toggle('hidden', showReg); 
            document.getElementById('register-section').classList.toggle('hidden', !showReg); 
        }
    </script>
</body>
</html>

